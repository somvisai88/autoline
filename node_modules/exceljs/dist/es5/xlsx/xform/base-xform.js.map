{"version":3,"sources":["../../../../lib/xlsx/xform/base-xform.js"],"names":["SAXStream","require","XmlStream","BaseXform","node","text","name","model","options","map","Object","values","forEach","xform","reset","obj","assign","saxStream","stream","Promise","resolve","reject","abort","error","sax","off","on","unpipe","parseOpen","parseText","parseClose","promise","parse","pipe","xmlStream","render","xml","toXml","value","dflt","always","undefined","toString","toAttribute","attr","parseInt","parseFloat","module","exports"],"mappings":"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","sourcesContent":["const SAXStream = require('../../utils/sax-stream');\r\nconst XmlStream = require('../../utils/xml-stream');\r\n\r\n/* 'virtual' methods used as a form of documentation */\r\n/* eslint-disable class-methods-use-this */\r\n\r\n// Base class for Xforms\r\nclass BaseXform {\r\n  // constructor(/* model, name */) {}\r\n\r\n  // ============================================================\r\n  // Virtual Interface\r\n  prepare(/* model, options */) {\r\n    // optional preparation (mutation) of model so it is ready for write\r\n  }\r\n\r\n  render(/* xmlStream, model */) {\r\n    // convert model to xml\r\n  }\r\n\r\n  parseOpen(node) {\r\n    // XML node opened\r\n  }\r\n\r\n  parseText(text) {\r\n    // chunk of text encountered for current node\r\n  }\r\n\r\n  parseClose(name) {\r\n    // XML node closed\r\n  }\r\n\r\n  reconcile(model, options) {\r\n    // optional post-parse step (opposite to prepare)\r\n  }\r\n\r\n  // ============================================================\r\n  reset() {\r\n    // to make sure parses don't bleed to next iteration\r\n    this.model = null;\r\n\r\n    // if we have a map - reset them too\r\n    if (this.map) {\r\n      Object.values(this.map).forEach(xform => {\r\n        if (xform instanceof BaseXform) {\r\n          xform.reset();\r\n        } else if (xform.xform) {\r\n          xform.xform.reset();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  mergeModel(obj) {\r\n    // set obj's props to this.model\r\n    this.model = Object.assign(this.model || {}, obj);\r\n  }\r\n\r\n  parse(saxStream, stream) {\r\n    return new Promise((resolve, reject) => {\r\n      const abort = error => {\r\n        // Abandon ship! Prevent the parser from consuming any more resources\r\n        saxStream.sax.off('opentag');\r\n        saxStream.sax.off('text');\r\n        saxStream.sax.off('closetag');\r\n        saxStream.sax.off('error');\r\n        saxStream.sax.off('end');\r\n        saxStream.sax.on('error', () => {}); // Ignore any parse errors from the chunk being processed\r\n        if (stream) {\r\n          stream.unpipe(saxStream);\r\n        }\r\n        reject(error);\r\n      };\r\n\r\n      saxStream.sax.on('opentag', node => {\r\n        try {\r\n          this.parseOpen(node);\r\n        } catch (error) {\r\n          abort(error);\r\n        }\r\n      });\r\n      saxStream.sax.on('text', text => {\r\n        try {\r\n          this.parseText(text);\r\n        } catch (error) {\r\n          abort(error);\r\n        }\r\n      });\r\n      saxStream.sax.on('closetag', node => {\r\n        try {\r\n          if (!this.parseClose(node.name)) {\r\n            resolve(this.model);\r\n          }\r\n        } catch (error) {\r\n          abort(error);\r\n        }\r\n      });\r\n      saxStream.sax.on('end', () => {\r\n        resolve(this.model);\r\n      });\r\n      saxStream.sax.on('error', error => {\r\n        abort(error);\r\n      });\r\n    });\r\n  }\r\n\r\n  parseStream(stream) {\r\n    const saxStream = new SAXStream();\r\n    const promise = this.parse(saxStream, stream);\r\n    stream.pipe(saxStream);\r\n\r\n    return promise;\r\n  }\r\n\r\n  get xml() {\r\n    // convenience function to get the xml of this.model\r\n    // useful for manager types that are built during the prepare phase\r\n    return this.toXml(this.model);\r\n  }\r\n\r\n  toXml(model) {\r\n    const xmlStream = new XmlStream();\r\n    this.render(xmlStream, model);\r\n    return xmlStream.xml;\r\n  }\r\n\r\n  // ============================================================\r\n  // Useful Utilities\r\n  static toAttribute(value, dflt, always = false) {\r\n    if (value === undefined) {\r\n      if (always) {\r\n        return dflt;\r\n      }\r\n    } else if (always || (value !== dflt)) {\r\n      return value.toString();\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  static toStringAttribute(value, dflt, always = false) {\r\n    return BaseXform.toAttribute(value, dflt, always);\r\n  }\r\n\r\n  static toStringValue(attr, dflt) {\r\n    return attr === undefined ? dflt : attr;\r\n  }\r\n\r\n  static toBoolAttribute(value, dflt, always = false) {\r\n    if (value === undefined) {\r\n      if (always) {\r\n        return dflt;\r\n      }\r\n    } else if (always || (value !== dflt)) {\r\n      return value ? '1' : '0';\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  static toBoolValue(attr, dflt) {\r\n    return attr === undefined ? dflt : attr === '1';\r\n  }\r\n\r\n  static toIntAttribute(value, dflt, always = false) {\r\n    return BaseXform.toAttribute(value, dflt, always);\r\n  }\r\n\r\n  static toIntValue(attr, dflt) {\r\n    return attr === undefined ? dflt : parseInt(attr, 10);\r\n  }\r\n\r\n  static toFloatAttribute(value, dflt, always = false) {\r\n    return BaseXform.toAttribute(value, dflt, always);\r\n  }\r\n\r\n  static toFloatValue(attr, dflt) {\r\n    return attr === undefined ? dflt : parseFloat(attr);\r\n  }\r\n}\r\n\r\nmodule.exports = BaseXform;\r\n"],"file":"base-xform.js"}